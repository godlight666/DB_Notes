# DB常见问题

1. ACID是什么？怎么实现？C和CAP中的有什么区别？
   
   1. 原子性(Atomicity)。事务中的操作要不都执行成功，要不都不执行。如果部分操作失败，则会回退到未执行的情况。
      
      1. 实现原理：实现原子性的关键，是当事务回滚时能够撤销所有已经成功执行的sql语句。InnoDB实现回滚靠的是undo log，当事务对数据库进行修改时，InnoDB会生成对应的undo log。如果事务执行失败或调用了rollback，导致事务需要回滚，便可以利用undo log中的信息将数据回滚到修改之前的样子。
   
   2. 一致性(Consistency)。指在事务发生前后，数据库始终保持一致性状态，前后都符合数据库完整性约束。相比较于CAP中的C强调的是外部一致性，即多个设备或者存储之间的一致性。
      
      - 保证原子性、持久性和隔离性，如果这些特性无法保证，事务的一致性也无法保证。
      
      - 数据库本身提供保障，例如不允许向整形列插入字符串值、字符串长度不能超过列的限制等。
      
      - 应用层面进行保障，例如如果转账操作只扣除转账者的余额，而没有增加接收者的余额，无论数据库实现的多么完美，也无法保证状态的一致
   
   3. 隔离性(Isolation)。要求每个事务的读写对象和其他事务的操作对象能相互分离，即该事务提交前对其他事务都不可见。通过锁来实现。
   
   4. 持久性(Durability)。事务一旦提交，结果是永久性的，即使发生宕机也能回复。
      
      1. 将修改写入磁盘。但是磁盘IO慢，所以有buffer pool。buffer pool定期写入磁盘，或者被换出的时候写入磁盘。**但是如果还没来得及将buffer pool中的page写入磁盘就宕机了，就出问题，所以有redo log**。
      
      2. 当数据修改时，除了修改Buffer Pool中的数据，还会在redo log记录这次操作。当事务提交时，会调用fsync接口对redo log进行刷盘。如果MySQL宕机，重启时可以读取redo log中的数据，对数据库进行恢复。redo log采用的是WAL（Write-ahead logging，预写式日志），所有修改先写入日志，再更新到Buffer Pool，保证了数据不会因MySQL宕机而丢失，从而满足了持久性要求。
      
      3. redo log写入磁盘为什么更快？redo log是追加操作，顺序写入。刷脏是随机IO。刷脏是以page为单位，redo log只需写入需要的部分。

### 事务的隔离级别是什么？要怎么实现？为了解决什么问题？

#### 可能造成的问题

1. 脏读取：事务A修改了某个数据，事务B读取了，事务A abort了，导致事务B读取到了脏数据。

2. 不可重复读：事务A读取了某个数据之后，进行了其他操作，然后这个数据被B修改了，事务A再读取的时候这个数据已经被修改了。

3. 幻象读：事务A读取某个数据之后，数据的行数发生了变化。与不可重复读的区别是幻象读是数据的行数被修改，不可重复读是数据被修改。

#### 解决方式（隔离级别）

1. 读取未提交（Read Uncommited，RU）：会碰到上面的三种问题。**读不加锁**，只在需要写数据的时候加排他锁，写完就unlock。

2. 读取已提交（Read Commited，RC）：解决了脏读取的问题。**读的时候加共享锁，读完就解共享锁。写的时候加排它锁，commit之后再解排他锁**。

3. 可重复读（Read Repeatable，RR）：解决了不可重复读的问题。严格两阶段锁协议（strict 2PL），在加锁阶段只能加锁，一旦开始解锁就进入shrinking阶段，该阶段就只能解锁，不能再加锁了。其实就相当于**共享锁也在commit之后了**。

### Buffer Pool可能碰到的问题和优化方式

[缓冲池(buffer pool)，这次彻底懂了！！！ - 掘金](https://juejin.cn/post/6844903874172551181)

### B树，B+树，红黑树，跳表

[红黑树、B(+)树、跳表、AVL等数据结构，应用场景及分析，以及一些英文缩写 - blcblc - 博客园](https://www.cnblogs.com/charlesblc/p/5987812.html)

https://github.com/wardseptember/notes/blob/master/docs/B%E6%A0%91%E5%92%8CB%2B%E6%A0%91%E8%AF%A6%E8%A7%A3.md

https://www.zhihu.com/question/20202931
